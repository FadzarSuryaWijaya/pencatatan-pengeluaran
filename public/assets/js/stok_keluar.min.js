let stok_keluar = $("#stok_keluar").DataTable({
    responsive: !0,
    scrollX: !0,
    ajax: readUrl,
    columnDefs: [{ searcable: !1, orderable: !1, targets: 0 }],
    order: [[1, "asc"]],
    columns: [
        { data: null },
        { data: "tanggal" },
        { data: "barcode" },
        { data: "nama_produk" },
        { data: "jumlah" },
        { data: "keterangan" },
    ],
});

function reloadTable() {
    stok_keluar.ajax.reload(null, false);
}

function addData() {
    // Show loading indicator
    Swal.fire({
        title: 'Memproses',
        html: 'Sedang memvalidasi dan menyimpan data...',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    $.ajax({
        url: addUrl,
        type: "post",
        dataType: "json",
        data: $("#form").serialize(),
        success: (response) => {
            if (response.status === 'success') {
                $(".modal").modal("hide");
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil',
                    html: `
                        <div style="text-align:left">
                            <p>${response.message}</p>
                            ${response.new_stock ? `<p>Stok baru: <strong>${response.new_stock}</strong></p>` : ''}
                        </div>
                    `,
                    confirmButtonText: 'Tutup'
                });
                reloadTable();
            } else {
                let errorHtml = `<div style="text-align:left"><p>${response.message}</p>`;
                
                if (response.current_stock !== undefined) {
                    errorHtml += `<p>Stok tersedia: <strong>${response.current_stock}</strong></p>`;
                    errorHtml += `<p>Jumlah diminta: <strong>${response.requested_amount}</strong></p>`;
                }
                
                if (response.errors) {
                    errorHtml += '<ul>';
                    for (const error in response.errors) {
                        errorHtml += `<li>${response.errors[error]}</li>`;
                    }
                    errorHtml += '</ul>';
                }
                
                errorHtml += '</div>';
                
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal',
                    html: errorHtml,
                    confirmButtonText: 'Tutup'
                });
            }
        },
        error: (xhr) => {
            let errorMessage = 'Terjadi kesalahan saat mengirim data';
            
            try {
                const response = JSON.parse(xhr.responseText);
                errorMessage = response.message || errorMessage;
            } catch (e) {
                console.error('Error parsing response:', e);
            }

            Swal.fire({
                icon: 'error',
                title: 'Error Sistem',
                text: errorMessage,
                confirmButtonText: 'Tutup'
            });
        }
    });
}

stok_keluar.on("order.dt search.dt", () => {
    stok_keluar
        .column(0, { search: "applied", order: "applied" })
        .nodes()
        .each((a, e) => {
            a.innerHTML = e + 1;
        });
});

$("#form").validate({
    errorElement: "span",
    errorPlacement: (a, e) => {
        a.addClass("invalid-feedback"), e.closest(".form-group").append(a);
    },
    submitHandler: () => {
        addData();
    },
});

$("#tanggal").datetimepicker({ format: "dd-mm-yyyy h:ii:ss" });

$("#barcode").select2({
    placeholder: "Cari produk...",
    minimumInputLength: 1,
    allowClear: false,
    ajax: {
        url: getBarcodeUrl,
        type: "post",
        dataType: "json",
        data: (a) => ({ barcode: a.term }),
        processResults: (a) => ({ results: a }),
    },
});

$(".modal").on("hidden.bs.modal", () => {
    $("#form")[0].reset(), $("#form").validate().resetForm();
});

$(".modal").on("show.bs.modal", () => {
    let a = moment().format("D-MM-Y H:mm:ss");
    $("#tanggal").val(a);
});